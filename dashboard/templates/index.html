<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Lottery Miner Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Inter, Arial, sans-serif; background:#0b1020; color:#e6f7ff; margin:0; padding:20px;}
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:16px;}
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:12px;}
    .card { background: rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.04); padding:12px; border-radius:8px;}
    .title { font-weight:700; margin-bottom:6px; font-size:16px;}
    .muted { color:#9fb3c8; font-size:12px;}
    .value { font-size:20px; font-weight:700; margin-top:6px;}
    .offline { color:#ff6b6b; font-weight:700;}
    .online { color:#57f287; font-weight:700;}
    .chart { width:100%; height:120px; }
    footer { margin-top:12px; font-size:12px; color:#9fb3c8;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <header>
    <div>
      <h1>⛏ Lottery Miner Dashboard</h1>
      <div class="muted">Multi-rig health & short-term trends</div>
    </div>
    <div class="muted">Auto-refresh via websocket-style polling</div>
  </header>

  <main id="main">
    <div class="grid" id="grid">
      <!-- cards will be injected -->
    </div>
  </main>

  <footer>
    Last update: <span id="ts">--</span> · Poll interval: {{ poll_interval }}s
  </footer>

<script>
const miners = {{ miners|tojson }};
const pollInterval = {{ poll_interval }};
const charts = {};

function humanHash(h){
  if(!h) return "0 H/s";
  if(h>1e9) return (h/1e9).toFixed(2)+" GH/s";
  if(h>1e6) return (h/1e6).toFixed(2)+" MH/s";
  if(h>1e3) return (h/1e3).toFixed(2)+" KH/s";
  return h.toFixed(2)+" H/s";
}

function buildCard(id){
  const container = document.createElement('div');
  container.className = 'card';
  container.id = `card-${id}`;

  container.innerHTML = `
    <div class="title">${id}</div>
    <div class="muted">Status: <span id="status-${id}">--</span></div>
    <div class="value" id="hash-${id}">--</div>
    <div class="muted">Accepted / Total: <span id="shares-${id}">0 / 0</span></div>
    <canvas id="chart-${id}" class="chart"></canvas>
  `;
  document.getElementById('grid').appendChild(container);

  // init chart
  const ctx = document.getElementById(`chart-${id}`).getContext('2d');
  charts[id] = new Chart(ctx, {
    type: 'line',
    data: { labels: [], datasets: [{ label: 'H/s', data: [], fill: true, tension:0.3 }] },
    options: { scales: { x: { display: false }, y: { ticks: { callback: function(v){ return v>1e6 ? (v/1e6).toFixed(1)+'M' : v } } } , animation:false, plugins:{legend:{display:false}}}
  });
}

function updateUI(data){
  document.getElementById('ts').innerText = new Date().toLocaleTimeString();
  for(const id of Object.keys(data)){
    const node = data[id];
    const latest = node.latest;
    const stat = node.status && node.status.online ? 'ONLINE' : 'OFFLINE';
    const statusEl = document.getElementById(`status-${id}`);
    if(!statusEl) buildCard(id);
    document.getElementById(`status-${id}`).innerHTML = node.status && node.status.online ? `<span class="online">ONLINE</span>` : `<span class="offline">OFFLINE</span>`;
    const hashEl = document.getElementById(`hash-${id}`);
    const sharesEl = document.getElementById(`shares-${id}`);
    if(latest){
      hashEl.innerText = humanHash(latest.hashrate_hs);
      sharesEl.innerText = `${latest.accepted} / ${latest.accepted + latest.rejected}`;
    } else {
      hashEl.innerText = "0 H/s";
      sharesEl.innerText = "0 / 0";
    }

    // update chart
    const hist = node.history || [];
    const labels = hist.map(s => new Date(s.ts*1000).toLocaleTimeString());
    const series = hist.map(s => s.hashrate_hs || 0);
    const ch = charts[id];
    if(ch){
      ch.data.labels = labels;
      ch.data.datasets[0].data = series;
      ch.update('none');
    }
  }
}

async function poll(){
  try {
    const res = await fetch('/api/miners');
    const data = await res.json();
    updateUI(data);
  } catch(e){
    console.error('poll err', e);
  } finally {
    setTimeout(poll, pollInterval*1000);
  }
}

// bootstrap UI cards
for(const id of miners){ if(id) buildCard(id); }
poll();
</script>
</body>
</html>
